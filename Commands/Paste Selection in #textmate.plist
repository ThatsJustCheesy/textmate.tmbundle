<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>beforeRunningCommand</key>
	<string>nop</string>
	<key>command</key>
	<string>paste_targets () {
   osascript &lt;&lt;"EOF"
      tell application "Colloquy"
         set AppleScript's text item delimiters to " "
         (name of chat room panels &amp; name of direct chat panels) as string
      end tell
EOF
}

if [[ -z "$TM_IRC_CHANNEL" ]] &amp;&amp; ps -xc|grep -sq 'Colloquy$'; then
  result=$(CocoaDialog dropdown \
    --title 'Paste to IRC' \
    --text 'Choose a chat room or user:' \
    --button1 Paste --button2 Cancel \
    --string-output --no-newline \
    --items $(paste_targets))

  if [[ "${result:0:5}" == "Paste" ]];
    then TM_IRC_CHANNEL="${result:6}"
    else exit_discard
  fi
fi

# set the language to one rafb.net supports
case $TM_MODE in
  C89|C|C++|C\#|Java|Pascal|Perl|PHP|PL/I|Python|Ruby|SQL|VB)
    # do nothing
  ;;
  *)
    TM_MODE="Plain Text"
  ;;
esac

: ${TM_PASTE_URL:=http://rafb.net/paste/paste.php}
url=$(curl "${TM_PASTE_URL}" -F nick="$USER" -F cvt_tabs="$TM_TAB_SIZE" -F text='&lt;-' -F lang="$TM_MODE" -s -L -o /dev/null -w "%{url_effective}" \
  2&gt; &gt;(CocoaDialog progressbar --indeterminate \
    --title "Paste to ${TM_IRC_CHANNEL}…" \
    --text "Contacting Server “${TM_PASTE_URL}”…" \
  ))

[[ -z "$url" ]] &amp;&amp; exit_show_tool_tip "Error: Got no URL back from pasting service."

if ps -xc|grep -sq 'Colloquy$'; then
  osascript -e "tell application \"Colloquy\" to send message \"pasted $url\" action tense yes to target of item 1 of (panels where name = \"$TM_IRC_CHANNEL\")"
  echo "The text was pasted to $TM_IRC_CHANNEL."
else
  echo -n "$url" | pbcopy
  echo "The text is available as $url"
  echo "For your convenience, the URL was placed on the clipboard."
fi
</string>
	<key>fallbackInput</key>
	<string>line</string>
	<key>input</key>
	<string>selection</string>
	<key>keyEquivalent</key>
	<string>^~V</string>
	<key>name</key>
	<string>Paste Line / Selection to IRC…</string>
	<key>output</key>
	<string>showAsTooltip</string>
	<key>uuid</key>
	<string>20B6054F-965B-4C9B-91DA-E6868A721954</string>
</dict>
</plist>
