<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>beforeRunningCommand</key>
	<string>nop</string>
	<key>command</key>
	<string>paste_targets () {
  osascript &lt;&lt;"APPLESCRIPT"
    tell application "Colloquy"
      set AppleScript's text item delimiters to " "
      (name of chat room panels &amp; name of direct chat panels) as string
    end tell
APPLESCRIPT
}

if [[ -z "$TM_IRC_CHANNEL" ]] &amp;&amp; ps -xc|grep -sq 'Colloquy$'; then
  result=$(CocoaDialog dropdown \
    --title 'Paste to IRC' \
    --text 'Choose a chat room or user:' \
    --button1 Paste --button2 Cancel \
    --string-output --no-newline \
    --items $(paste_targets))

  if [[ "${result:0:5}" == "Paste" ]];
    then TM_IRC_CHANNEL="${result:6}"
    else exit_discard
  fi
fi

# set the language to one pastie supports
TM_LANG=$(cut &lt;&lt;&lt;"$TM_SCOPE" -d. -f2)
case "$TM_LANG" in
  diff|javascript|ruby|sql|html)
    ;;
  c++|objc|objc++)
    TM_LANG=c
    ;;
  *)
    TM_LANG=plaintext
esac

TM_HTML=$("${TM_RUBY:-ruby}" -rjcode -Ku -r"$TM_BUNDLE_SUPPORT/lib/doctohtml.rb" -e 'print document_to_html(STDIN.read)')

url=$(echo -n "$TM_SELECTED_TEXT"|curl http://pastie.caboo.se/pastes/create \
    -s -L -o /dev/null -w "%{url_effective}" \
    -H "Expect:" \
    -F "paste[nick]=$USER" \
    -F "paste[parser]=$TM_LANG" \
    -F "paste[tab_size]=$TM_TAB_SIZE" \
    -F "paste[body]=&lt;-" \
    -F "paste[textmate_html]=&amp;zwj;$TM_HTML" \
  2&gt; &gt;(CocoaDialog progressbar --indeterminate \
    --title "Paste to ${TM_IRC_CHANNEL}…" \
    --text "Contacting Server “${TM_PASTE_URL}”…" \
  ))

[[ -z "$url" ]] &amp;&amp; exit_show_tool_tip "Error: Got no URL back from pasting service."

if ps -xc|grep -sq 'Colloquy$'; then
  osascript -e "tell application \"Colloquy\" to send message \"pasted $url\" action tense yes to target of item 1 of (panels where name = \"$TM_IRC_CHANNEL\")"
  echo "The text was pasted to $TM_IRC_CHANNEL."
else
  echo -n "$url" | pbcopy
  echo "The text is available as $url"
  echo "For your convenience, the URL was placed on the clipboard."
fi
</string>
	<key>fallbackInput</key>
	<string>line</string>
	<key>input</key>
	<string>selection</string>
	<key>inputFormat</key>
	<string>xml</string>
	<key>keyEquivalent</key>
	<string>^~V</string>
	<key>name</key>
	<string>Paste Line / Selection to IRC…</string>
	<key>output</key>
	<string>showAsTooltip</string>
	<key>uuid</key>
	<string>20B6054F-965B-4C9B-91DA-E6868A721954</string>
</dict>
</plist>
